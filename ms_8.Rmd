---
title: "ms_8"
author: "Rachel Phan"
date: "4/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(janitor)
library(readr)
library(readxl)
library(lubridate)
library(stringr)
library(gganimate)
library(ggplot2)
library(usmap)
library(maps)
library(gganimate)
library(scales)
library(infer)
library(broom)
library(tidyverse)
library(ggcorrplot)
library(gt)
```


```{r loading data, include=FALSE}

# Obesity data from https://chronicdata.cdc.gov/Nutrition-Physical-Activity-and-Obesity/Nutrition-Physical-Activity-and-Obesity-Behavioral/hn4x-zwk7/data (Center for Disease Control)

obesity_x <- read_csv("Nutrition__Physical_Activity__and_Obesity_-_Behavioral_Risk_Factor_Surveillance_System.csv")

# Food access data from https://www.ers.usda.gov/data-products/food-access-research-atlas/ (United States Department of Agriculture)

food_access_x <- read_excel("Food Accessibility.xlsx", sheet = 3)

# Rural income data from https://www.ers.usda.gov/data-products/atlas-of-rural-and-small-town-america/ (United States Department of Agriculture)

rural_income <- read_csv("Rural Atlas Data/Income.csv")

# Income data for all US Counties from https://www.ers.usda.gov/data-products/county-level-data-sets/download-data/ (US Bureau of Labour Statistics)

income <- read_excel("Unemployment.xls", skip = 4)

# Consumer Price Index ata from https://www.ers.usda.gov/data-products/food-price-outlook/ (United States Department of Agriculture)

cpi <- read_excel("historicalcpi.xlsx", skip = 1)

# What I want to observe here is how different variables affect obesity in the US - income, food accessibility, year, ethnicity, food price, which users can choose from when they pick the graph. Then I want to map out obesity/BMI onto a map of the US. I 

# If obesity is affected by food access, then can look deeper into food access. How does ruralness affect food access? How do consumer food price indexes affect food accessibility? How does SNAP policy affect food access (can look at SNAP data from USDA: https://www.ers.usda.gov/data-products/snap-policy-data-sets/).

```

```{r clean obesity data, include=FALSE}

obesity_x <- obesity_x %>% 
    select(YearStart, LocationAbbr, Class, Data_Value, Low_Confidence_Limit, High_Confidence_Limit,
           Sample_Size, "Age(years)", Education, Gender, Income, "Race/Ethnicity")

obesity <- obesity_x %>% 
    rename("state" = LocationAbbr,
           "year" = YearStart,
           "perc_obese" = Data_Value,
           "conf.low" = Low_Confidence_Limit,
           "conf.high" = High_Confidence_Limit,
           "sample_size" = Sample_Size,
           "age" = "Age(years)",
           "education" = Education,
           "gender" = Gender,
           "class" = Class,
           "race" = "Race/Ethnicity",
           "income" = Income) %>% 
    filter(class == "Obesity / Weight Status",
           !is.na(perc_obese)) %>% 
    select(-class)

```

```{r obesity mean by year, include=FALSE}

# Maybe choose a state to look at its obesity rate change over time

obesity_mean <- obesity %>% 
    group_by(state, year) %>% 
    summarise(mean_perc = mean(perc_obese)) %>% 
    filter(state != "US")

saveRDS(obesity_mean, file = "obesity_mean.RDS")

obesity_mean_plot <- plot_usmap(data = obesity_mean, values = "mean_perc", color = "red", labels = FALSE) +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5)) + 
    scale_fill_continuous(low = "white", high = "red", name = "Percent Obese") +
    labs(title = "Percent of Population (age 18+) Classified as Obese or Overweight in the US \n Year:
         {as.integer(frame_time)}",
         subtitle = "Percent of population tends to increase as time goes on",
         caption = "Data from Center for Disease Control") +
    theme_void() +
    transition_time(year)

animate(obesity_mean_plot)

anim_save("plots/obesity_mean_usmap.gif", plot = last_animation())

```

```{r obesity by region, include=FALSE}

obesity_region <- obesity_mean %>% 
    mutate(region = case_when(
        state %in% c("CT", "MA", "ME", "NH", "RI", "VT", "NJ", "NY", "PA") ~ "Northeast",
        state %in% c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD") ~ "Midwest",
        state %in% c("DC", "DE", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "AL", "KY", "MS", "TN", "AR", 
                     "LA", "OK", "TX") ~ "South",
        state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA") ~ "West")
    ) %>% 
    mutate(year = as.numeric(year)) %>% 
  mutate(mean_perc = round(mean_perc, digits = 0))

saveRDS(obesity_region, file = "./obesity_shiny/data/obesity_region.RDS")

obesity_region_plot <- obesity_region %>% 
    filter(!is.na(region)) %>%
    ggplot(aes(color = region, x = year, y = mean_perc)) +
    geom_jitter(aes(alpha = 0.1), show.legend = FALSE) +
    theme(panel.grid.major.y = element_blank(),
          panel.grid.minor.x = element_blank()) + 
    theme_minimal() +
    labs(title = "Percent of Population Classified as Obese or Overweight \n in US Over Time by Region",
         caption = "Data from Center for Disease Control",
         y = "Mean Percent of Population",
         x = "Year",
         color = "Region") +
    geom_smooth(method = "lm", se = FALSE, formula = y ~ x) +
    facet_wrap(~ region)

obesity_region_plot
    
ggsave("plots/obesity_region_plot.png", plot = last_plot())

```

```{r clean food access data, include=FALSE}

food_access_x <- food_access_x %>% 
    select(State, County, Urban, POP2010, LILATracts_1And10, PovertyRate, MedianFamilyIncome, 
           LA1and10, LAPOP1_10, LALOWI1_10)

food_access_y <- food_access_x %>% 
    rename("state" = State,
           "county" = County,
           "popul" = POP2010,
           "urban" = Urban,
           "poverty" = PovertyRate,
           "med_income" = MedianFamilyIncome,
           "lia_1_10" = LILATracts_1And10,
           "la_1_10" = LA1and10,
           "lia_pop"= LALOWI1_10,
           "la_pop" = LAPOP1_10) %>% 
    mutate(urban = as.factor(urban),
           lia_1_10 = as.factor(lia_1_10),
           la_1_10 = as.factor(la_1_10))

food_access_y$state = state.abb[match(food_access_y$state, state.name)]

food_access <- food_access_y %>% 
    mutate(region = case_when(
        state %in% c("CT", "MA", "ME", "NH", "RI", "VT", "NJ", "NY", "PA") ~ "Northeast",
        state %in% c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD") ~ "Midwest",
        state %in% c("DC", "DE", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "AL", "KY", "MS", "TN", "AR", 
                     "LA", "OK", "TX") ~ "South",
        state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA") ~ "West")
    ) %>% 
    select(-county) 

saveRDS(food_access, file = "./obesity_shiny/data/food_access.RDS")

```

```{r mean poverty by state, include = FALSE}

food_poverty_mean <- food_access %>%
    filter(!is.na(region)) %>% 
    group_by(state) %>% 
    summarise(mean_poverty = mean(poverty))

saveRDS(food_poverty_mean, file = "./obesity_shiny/data/food_poverty_mean.RDS")

food_poverty_mean_plot <- plot_usmap(data = food_poverty_mean, values = "mean_poverty", 
                                     color = "white", labels = FALSE) +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5)) + 
    scale_fill_continuous(low = "white", high = "blue", name = "Mean Poverty Rate") +
    labs(title = "Poverty Rate in the US",
         caption = "Data from US Department of Agriculture and 2010 Census Bureau") +
    theme_void()
food_poverty_mean_plot

ggsave("plots/food_poverty_plot.png", plot = last_plot())

```

```{r food access lia distribution, include=FALSE}

food_lia <- food_access %>%
    filter(!is.na(region)) %>% 
    group_by(state, region) %>% 
    summarise(perc = sum(lia_1_10 == 1)/n()) %>% 
    mutate(perc = perc*100) %>% 
    mutate(perc = round(as.numeric(perc), digits = 0)) %>% 
    arrange(perc)

saveRDS(food_lia, file = "./obesity_shiny/data/food_lia.RDS")

# Maybe could input the region in Shiny and people can play around with that?

food_lia_plot <- food_lia %>% 
    group_by(region) %>% 
    ggplot(aes(y = reorder(state, perc), x = perc, fill = region)) +
    geom_col() +
    theme_minimal() +
    theme(axis.text.y = element_text(hjust = 1, size = 5.5),
          panel.grid.major.y = element_line(color = "white"),
          panel.grid.minor.y = element_line(color = "white"),
          plot.subtitle = element_text(size = 8)) +
    labs(title = "Percent of Counties with a Lack of Food Access and Low Income Population",
         subtitle = "Lack of Food Access Defined by 33% of the Population Living More Than \n 1 Mile (Urban) Or 10 Miles (Rural) Away from Supermarket, Supercenter, or Grocery Store Who are Low Income",
         caption = "Data from US Department of Agriculture and 2010 Census Bureau",
         x = "Percent of Counties",
         y = "State",
         fill = "Region") +
    geom_text(aes(label = perc), hjust = -0.3, size = 2)

food_lia_plot

ggsave("plots/food_lia_plot.png", plot = last_plot())

```

```{r join obesity and food access, include=FALSE}

obesity <- obesity %>% 
     mutate(region = case_when(
        state %in% c("CT", "MA", "ME", "NH", "RI", "VT", "NJ", "NY", "PA") ~ "Northeast",
        state %in% c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD") ~ "Midwest",
        state %in% c("DC", "DE", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "AL", "KY", "MS", "TN", "AR", 
                     "LA", "OK", "TX") ~ "South",
        state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA") ~ "West")
    ) %>% 
    mutate(year = as.numeric(year))

obesity_2011 <- obesity %>% 
    filter(year == 2011) %>%
    group_by(state, age, gender, income, race) %>% 
    summarise(mean_perc_obese = round(mean(perc_obese), digits = 0)) %>% 
    filter(state != "US" & state != "DC")

food_sum <- food_access %>% 
    group_by(state, urban) %>% 
    mutate(total_pop = sum(popul),
           total_lia_pop = sum(lia_pop),
           total_la_pop = sum(la_pop),
           perc_lia = round((total_lia_pop/total_pop)*100, digits = 0),
           perc_la = round((total_la_pop/total_pop)*100, digits = 0)) %>% 
    group_by(state, perc_lia, perc_la, urban) %>% 
    summarise(mean_poverty = round(mean(poverty), digits = 0)) %>% 
    filter(!is.na(state))

joined <- left_join(obesity_2011, food_sum, by = "state") %>% 
    mutate(region = case_when(
        state %in% c("CT", "MA", "ME", "NH", "RI", "VT", "NJ", "NY", "PA") ~ "Northeast",
        state %in% c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD") ~ "Midwest",
        state %in% c("DC", "DE", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "AL", "KY", "MS", "TN", "AR", 
                     "LA", "OK", "TX") ~ "South",
        state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA") ~ "West"),
        urban = case_when(
            urban == 0 ~ "urban",
            urban == 1 ~ "rural")
    ) 

```

```{r relationship between obesity and different variables}

sapply(joined, class)

joined <- joined %>% 
    ungroup() %>% 
    mutate(age = as.factor(age),
           gender = as.factor(gender),
           race = as.factor(race),
           urban = as.factor(urban),
           region = as.factor(region))

joined_cor <- joined %>% 
    mutate("Obesity Rate" = mean_perc_obese,
           "% Low Income and Food Access" = perc_lia,
           "% Low Food Access" = perc_la,
           "Poverty Rate" = mean_poverty) %>% 
    select("Obesity Rate", "% Low Income and Food Access", "% Low Food Access", "Poverty Rate") %>% 
    cor() 

corrplot <- ggcorrplot(joined_cor, 
             type = "upper", 
             colors = c("blue", "white", "blue"),
             lab = TRUE,
             lab_size = 4,
             lab_col = "black",
             ggtheme = theme_void) +
             labs(title = "Correlations Between Obesity, \n Poverty, and Food Access")  + 
             theme(plot.title = element_text(hjust = 0.5, size = 15),
                   legend.position = "none")

ggsave("plots/corr_plot.png", plot = corrplot)

```

```{r gt}

#yield a graph showing how the mean percentage of obesity is affected by different variables

bootstrap_joined <- joined %>% 
  rep_sample_n(size = 50, replace = TRUE, reps = 1000) %>% 
  group_by(replicate)

saveRDS(bootstrap_joined, file = "./obesity_shiny/data/bootstrap_joined.RDS")

joined_lm_lia <- lm(mean_perc_obese ~ perc_lia, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high) %>% 
  mutate(
    estimate = round(estimate, digits = 3),
    conf.low = round(conf.low, digits = 3),
    conf.high = round(conf.high, digits = 4))

joined_lm_lia_gt <- joined_lm_lia %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Low Food Access and Low Income on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))

gtsave(joined_lm_lia_gt, "lia_gt.html")

joined_lm_gender <- lm(mean_perc_obese ~ gender, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high) %>% 
  mutate(
    estimate = round(estimate, digits = 3),
    conf.low = round(conf.low, digits = 3),
    conf.high = round(conf.high, digits = 4))

joined_lm_gender_gt <- joined_lm_gender %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Gender on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))

gtsave(joined_lm_gender_gt, "gender_gt.html")

joined_lm_age <- lm(mean_perc_obese ~ age, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
    select(term, estimate, conf.low, conf.high) %>% 
    mutate(
      estimate = round(estimate, digits = 3),
      conf.low = round(conf.low, digits = 3),
      conf.high = round(conf.high, digits = 4))

joined_lm_age_gt <- joined_lm_age %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Age on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))
  
joined_lm_race <- lm(mean_perc_obese ~ race, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high) %>% 
  mutate(
    estimate = round(estimate, digits = 3),
    conf.low = round(conf.low, digits = 3),
    conf.high = round(conf.high, digits = 4))

joined_lm_race_gt <- joined_lm_race %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Race on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))

joined_lm_la <- lm(mean_perc_obese ~ perc_la, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high) %>% 
  mutate(
    estimate = round(estimate, digits = 3),
    conf.low = round(conf.low, digits = 3),
    conf.high = round(conf.high, digits = 4))

joined_lm_la_gt <- joined_lm_la %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Low Food Access on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))

joined_lm_urban <- lm(mean_perc_obese ~ urban, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high) %>% 
  mutate(
    estimate = round(estimate, digits = 3),
    conf.low = round(conf.low, digits = 3),
    conf.high = round(conf.high, digits = 4))

joined_lm_urban_gt <- joined_lm_urban %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Ruralness on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))

joined_lm_mean_poverty <- lm(mean_perc_obese ~ mean_poverty, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high) %>% 
  mutate(
    estimate = round(estimate, digits = 3),
    conf.low = round(conf.low, digits = 3),
    conf.high = round(conf.high, digits = 4))

joined_lm_poverty_gt <- joined_lm_mean_poverty %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Poverty on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))

joined_lm_region <- lm(mean_perc_obese ~ region, data = bootstrap_joined) %>% 
  tidy(conf.int = TRUE) %>%
  select(term, estimate, conf.low, conf.high) %>% 
  mutate(
    estimate = round(estimate, digits = 3),
    conf.low = round(conf.low, digits = 3),
    conf.high = round(conf.high, digits = 4))

joined_lm_region_gt <- joined_lm_region %>% 
  gt() %>% 
  tab_header(
    title = "Effect of Region in the US on Average Percentage of Obesity in a Population") %>%
  cols_label(
    term = "Variable", 
    estimate = "Estimate",
    conf.low = "Lower Bound",
    conf.high = "Higher Bound") %>% 
   tab_spanner(
    label = "Data from 2010 Census Bureau, USDA, and CDC",
    columns = vars(term, estimate, conf.low, conf.high))

joined_poverty_obesity <- bootstrap_joined %>% 
  ggplot(aes(x = mean_poverty, y = mean_perc_obese)) +
  geom_jitter(aes(color = urban)) +
  scale_color_manual(values = c("purple", "dark red")) +
  theme_minimal() +
  theme(panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(title = "Poverty Rate on Obesity Rate",
       caption = "Data from US Department of Agriculture and 2010 Census Bureau",
       color = "Ruralness",
       x = "Mean Poverty Rate",
       y = "Mean Obesity Rate") +
  geom_smooth(method = "lm", color = "black")
joined_poverty_obesity

```

An Introduction

- Introduce the issue
- Describe what obesity is 
- Describe what food insecurity is

Variables in question

Obesity
Obesity over time map
Choose region to look at map
The poverty map
Should make a graph showing how poverty relates to obesity

Food lia
Could allow people to choose between which regions they want to compare

Findings
Correlation plot
Make best fit line graphs for each variable that affects obesity and allow people to choose which one they want to look at
Make a regression plot
  Otherwise, gt tables?
  
Data
Give process of creation of the data 
Give sources 

Me
Self introdcution
Provide links to github and linkedin 








