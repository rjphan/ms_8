---
title: "ms_8"
author: "Rachel Phan"
date: "4/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(readr)
library(readxl)
library(lubridate)
library(stringr)
library(gganimate)
library(ggplot2)
library(usmap)
library(maps)
library(gganimate)
```


```{r loading data, include=FALSE}

# Obesity data from https://chronicdata.cdc.gov/Nutrition-Physical-Activity-and-Obesity/Nutrition-Physical-Activity-and-Obesity-Behavioral/hn4x-zwk7/data (Center for Disease Control)

obesity_x <- read_csv("Nutrition__Physical_Activity__and_Obesity_-_Behavioral_Risk_Factor_Surveillance_System.csv")

# Food access data from https://www.ers.usda.gov/data-products/food-access-research-atlas/ (United States Department of Agriculture)

food_access_x <- read_excel("Food Accessibility.xlsx", sheet = 3)

# Rural income data from https://www.ers.usda.gov/data-products/atlas-of-rural-and-small-town-america/ (United States Department of Agriculture)

rural_income <- read_csv("Rural Atlas Data/Income.csv")

# Income data for all US Counties from https://www.ers.usda.gov/data-products/county-level-data-sets/download-data/ (US Bureau of Labour Statistics)

income <- read_excel("Unemployment.xls", skip = 4)

# Consumer Price Index ata from https://www.ers.usda.gov/data-products/food-price-outlook/ (United States Department of Agriculture)

cpi <- read_excel("historicalcpi.xlsx", skip = 1)

# What I want to observe here is how different variables affect obesity in the US - income, food accessibility, year, ethnicity, food price, which users can choose from when they pick the graph. Then I want to map out obesity/BMI onto a map of the US. I 

# If obesity is affected by food access, then can look deeper into food access. How does ruralness affect food access? How do consumer food price indexes affect food accessibility? How does SNAP policy affect food access (can look at SNAP data from USDA: https://www.ers.usda.gov/data-products/snap-policy-data-sets/).

```

```{r clean obesity data, include=FALSE}

obesity_x <- obesity_x %>% 
    select(YearStart, LocationAbbr, Class, Data_Value, Low_Confidence_Limit, High_Confidence_Limit,
           Sample_Size, "Age(years)", Education, Gender, Income, "Race/Ethnicity")

obesity <- obesity_x %>% 
    rename("state" = LocationAbbr,
           "year" = YearStart,
           "perc_obese" = Data_Value,
           "conf.low" = Low_Confidence_Limit,
           "conf.high" = High_Confidence_Limit,
           "sample_size" = Sample_Size,
           "age" = "Age(years)",
           "education" = Education,
           "gender" = Gender,
           "class" = Class,
           "race" = "Race/Ethnicity",
           "income" = Income) %>% 
    filter(class == "Obesity / Weight Status",
           !is.na(perc_obese)) %>% 
    select(-class)

```

```{r obesity mean plot, include=FALSE}

obesity_mean <- obesity %>% 
    group_by(state, year) %>% 
    summarise(mean_perc = mean(perc_obese)) %>% 
    filter(state != "US")

obesity_mean_plot <- plot_usmap(data = obesity_mean, values = "mean_perc", color = "red", labels = FALSE) +
    theme(legend.position = "right",
          plot.title = element_text(hjust = 0.5)) + 
    scale_fill_continuous(low = "white", high = "red", name = "Percent Obese") +
    labs(title = "Percent of Population (age 18+) Classified as Obese or Overweight in the US \n Year: {as.integer(frame_time)}",
         subtitle = "Percent of population tends to increase as time goes on",
         caption = "Data from Center for Disease Control") +
    theme_void() +
    transition_time(year)

animate(obesity_mean_plot)

anim_save("plots/obesity_mean_usmap.gif", plot = last_animation())

```

```{r obesity by region}

obesity_region <- obesity_mean %>% 
    mutate(region = case_when(
        state %in% c("CT", "MA", "ME", "NH", "RI", "VT", "NJ", "NY", "PA") ~ "Northeast",
        state %in% c("IL", "IN", "MI", "OH", "WI", "IA", "KS", "MN", "MO", "NE", "ND", "SD") ~ "Midwest",
        state %in% c("DC", "DE", "FL", "GA", "MD", "NC", "SC", "VA", "WV", "AL", "KY", "MS", "TN", "AR", 
                     "LA", "OK", "TX") ~ "South",
        state %in% c("AZ", "CO", "ID", "MT", "NV", "NM", "UT", "WY", "AK", "CA", "HI", "OR", "WA") ~ "West")
    ) %>% 
    mutate(year = as.numeric(year)) %>% 
  mutate(mean_perc = round(mean_perc, digits = 0))

obesity_region_plot <- obesity_region %>% 
    filter(!is.na(region)) %>%
    ggplot(aes(color = region, x = year, y = mean_perc)) +
    geom_jitter(aes(alpha = 0.1), show.legend = FALSE) +
    theme_minimal() +
    labs(title = "Percent of Population Classified as Obese or Overweight \n in US Over Time by Region",
         caption = "Data from Center for Disease Control",
         x = "Mean Percent of Population",
         y = "Year",
         color = "Region") +
    geom_smooth(method = "lm", se = FALSE, formula = y ~ x) +
    facet_wrap(~ region)
obesity_region_plot
    
ggsave("plots/obesity_region_plot.png", plot = last_plot())

```

```{r clean food access data, include=FALSE}

food_access_x <- food_access_x %>% 
    select(State, County, Urban, POP2010, LILATracts_1And10, PovertyRate, MedianFamilyIncome, LA1and10, LAPOP1_10)

food_access <- food_access_x %>% 
    rename("state" = State,
           "county" = County,
           "popul" = POP2010,
           "urban" = Urban,
           "lia_1_10" = LILATracts_1And10,
           "poverty_rate" = PovertyRate,
           "med_income" = MedianFamilyIncome,
           "la_1_10" = LA1and10,
           "la_popul" = LAPOP1_10) %>% 
    mutate(urban = as.factor(urban),
           lia_1_10 = as.factor(lia_1_10),
           la_1_10 = as.factor(la_1_10))

food_access$state = state.abb[match(food_access$state, state.name)]

View(food_access)

```


Shiny App

 fluidPage(

    titlePanel("GOV1005 Final Project"),
    
    navlistPanel("Header A",
                 tabPanel("Component 1"),
                 "Header B",
                 tabPanel("Component 3"),
                 tabPanel("Component 4")
    ),

    sidebarLayout(position = "right",
        sidebarPanel(img(src = "cartoon.png", height = 140, width = 200)),
        mainPanel(h3("Red Meat Production in the US Over Time"),
                  imageOutput("meat_clean_plot"),
                  br(),
                  br(),
                  br(),
                  br(),
                  br(),
                  br(),
                  actionButton("action", "Click")
    )
)

)

# Define server logic required to draw a histogram
server <- function(input, output) {
    
    output$meat_clean_plot <- renderImage({
        list(src = "meat_clean_plot.png",
             contentType = 'image/png',
             width = 550,
             height = 500)},
        deleteFile = FALSE
    )  
}